п»ї
/*
Р—Р°РґР°РЅРёРµ 2
РџСЂРѕРіСЂРµСЃСЃ-Р±Р°СЂ
РЎРѕР·РґР°Р№С‚Рµ РєРѕРЅСЃРѕР»СЊРЅРѕРµ РїСЂРёР»РѕР¶РµРЅРёРµ РґР»СЏ РёРјРёС‚Р°С†РёРё РјРЅРѕРіРѕРїРѕС‚РѕС‡РЅРѕРіРѕ СЂР°СЃС‡С‘С‚Р°.
РљРѕР»РёС‡РµСЃС‚РІРѕ РїРѕС‚РѕРєРѕРІ, РґР»РёРЅР° СЂР°СЃС‡С‘С‚Р° РґРѕР»Р¶РЅС‹ Р±С‹С‚СЊ Р·Р°РґР°РЅС‹ РїРµСЂРµРјРµРЅРЅС‹РјРё.
Р’ РєРѕРЅСЃРѕР»СЊ РІРѕ РІСЂРµРјСЏ СЂР°Р±РѕС‚С‹ РїСЂРѕРіСЂР°РјРјС‹ РґРѕР»Р¶РЅС‹ РїРѕСЃС‚СЂРѕС‡РЅРѕ РґР»СЏ РєР°Р¶РґРѕРіРѕ РїРѕС‚РѕРєР° РІС‹РІРѕРґРёС‚СЊСЃСЏ:

вЂў РЅРѕРјРµСЂ РїРѕС‚РѕРєР° РїРѕ РїРѕСЂСЏРґРєСѓ;
вЂў РёРґРµРЅС‚РёС„РёРєР°С‚РѕСЂ РїРѕС‚РѕРєР°;
вЂў Р·Р°РїРѕР»РЅСЏСЋС‰РёР№СЃСЏ РёРЅРґРёРєР°С‚РѕСЂ РЅР°РїРѕРґРѕР±РёРµ РїСЂРѕРіСЂРµСЃСЃ-Р±Р°СЂР°, РІРёР·СѓР°Р»РёР·РёСЂСѓСЋС‰РёР№ РїСЂРѕС†РµСЃСЃ В«СЂР°СЃС‡С‘С‚Р°В»;
вЂў РїРѕСЃР»Рµ Р·Р°РІРµСЂС€РµРЅРёСЏ СЂР°Р±РѕС‚С‹ РєР°Р¶РґРѕРіРѕ РїРѕС‚РѕРєР° РІ СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‰РµР№ СЃС‚СЂРѕРєРµ СЃСѓРјРјР°СЂРЅРѕРµ РІСЂРµРјСЏ, 
Р·Р°С‚СЂР°С‡РµРЅРЅРѕРµ РЅР° СЂР°Р±РѕС‚Сѓ РїРѕС‚РѕРєР°.

РЎС‚СЂРѕРєРё РїСЂРѕРіСЂРµСЃСЃ-Р±Р°СЂРѕРІ РєР°Р¶РґРѕРіРѕ РїРѕС‚РѕРєР° РґРѕР»Р¶РЅС‹ РІС‹РІРѕРґРёС‚СЊСЃСЏ РѕРґРЅРѕРІСЂРµРјРµРЅРѕ. 
Р’СЂРµРјСЏ РїРѕСЏРІР»РµРЅРёСЏ РєР°Р¶РґРѕРіРѕ РЅРѕРІРѕРіРѕ СЃРёРјРІРѕР»Р° РІ СЃС‚СЂРѕРєРµ РїСЂРѕРіСЂРµСЃСЃ-Р±Р°СЂР° РїРѕРґР±РµСЂРёС‚Рµ С‚Р°Рє, 
С‡С‚РѕР±С‹ РїСЂРѕС†РµСЃСЃ Р·Р°РїРѕР»РЅРµРЅРёСЏ СЃС‚СЂРѕРєРё Р±С‹Р» РІРёРґРµРЅ. РџСЂРёРјРµСЂ СЂР°Р±РѕС‚С‹ РїСЂРѕРіСЂР°РјРјС‹ РїРѕ СЃСЃС‹Р»РєРµ.

Р”РѕРїРѕР»РЅРµРЅРёРµ Рє Р·Р°РґР°РЅРёСЋ 2*
Р’Рѕ РІСЂРµРјСЏ РѕС‡РµСЂРµРґРЅРѕР№ РёС‚РµСЂР°С†РёРё В«СЂР°СЃС‡С‘С‚Р°В» СЃС‹РјРёС‚РёСЂСѓР№С‚Рµ СЃРѕ СЃР»СѓС‡Р°Р№РЅРѕР№ РІРµСЂРѕСЏС‚РЅРѕСЃС‚СЊСЋ 
РІРѕР·РЅРёРєРЅРѕРІРµРЅРёРµ РѕС€РёР±РєРё (exception), РєРѕС‚РѕСЂР°СЏ РЅРµ РґРѕР»Р¶РЅР° РїСЂРёРІРѕРґРёС‚СЊ Рє РїСЂРµРєСЂР°С‰РµРЅРёСЋ 
СЂР°Р±РѕС‚С‹ РїРѕС‚РѕРєР° РёР»Рё РїСЂРѕРіСЂР°РјРјС‹. РџСЂРё СЌС‚РѕРј СЌС‚РѕС‚ С„Р°РєС‚ РґРѕР»Р¶РµРЅ РІРёР·СѓР°Р»РёР·РёСЂРѕРІР°С‚СЊСЃСЏ 
РѕС‚РґРµР»СЊРЅС‹Рј С†РІРµС‚РѕРј РЅР° РїСЂРѕРіСЂРµСЃСЃ-Р±Р°СЂРµ.
*/

#include <iostream>
#include <string>
#include <thread>
#include <random>
#include <Windows.h>
#include <chrono>
#include <mutex>
#include <functional>
#include <exception>


std::mutex mt;

void SetCursor(int x, int y) {

    COORD position = { x,y }; //РїРѕР·РёС†РёСЏ x Рё y
    HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
    SetConsoleCursorPosition(hConsole, position);
}

void SetColor(int textColor, int bgColor)
{
    HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
    SetConsoleTextAttribute(hConsole, (bgColor << 4) | textColor);
}


struct AAA {

    AAA() {}

    AAA(const int& long_math, const int& blocks) :
        _thr_blocks(blocks), _long_math(long_math)
    {
        _vec_lambda.clear();
        _threads.clear();

        //СЃРѕР·РґР°РЅРёРµ РІРµРєС‚РѕСЂР° Р»СЏРјР±Рґ - РѕС‚РґРµР»СЊРЅРѕ С‡С‚РѕР±С‹ РёРјРµС‚СЊ РіРёР±РєРѕСЃС‚СЊ РІ СЃРёСЃС‚РµРјРµ
        for (int i = 0; i < _thr_blocks; ++i) {
            _vec_lambda.push_back(([this, i]() {  math_block(i); }));
        }

        //СЃРѕР·РґР°РЅРёРµ РІРµРєС‚РѕСЂР° РїРѕС‚РѕРєРѕРІ СЃ РѕРґРЅРѕРІСЂРµРјРµРЅРЅРѕР№ РёРЅРёС†РёР°Р»РёР·Р°С†РёРµР№ РІ РїРѕС‚РѕРєР°С… С„СѓРЅРєС†РёР№ РёР· РІРµРєРєС‚РѕСЂР° Р»СЏРјР±Рґ
        for (const auto& s : _vec_lambda) {            
            _threads.emplace_back(s);            
        }


    }

    ~AAA() {
        //Р·Р°РїСѓСЃРє РїРѕС‚РѕРєРѕРІ Рё РѕСЃС‚Р°РЅРѕРІРєР° РІС‹РїРѕР»РЅРµРЅРёСЏ РґР°Р»СЊРЅРµР№С€РµРіРѕ РєРѕРґР° РґРѕ Р·Р°РІРµСЂС€РµРЅРёСЏ СЂР°Р±РѕС‚С‹ РїРѕС‚РѕРєРѕРІ
        for (auto& t : _threads) {
            t.join();
        }
    };

    //РёРјРёС‚Р°С‚РѕСЂ СЂР°СЃС‡РµС‚Р°
    void math_block(const int& number_th) {                
  //РёРјРёРјС‚Р°С†РёСЏ СЂР°СЃС‡РµС‚Р° СЃ Р·Р°С…РІР°С‚РѕРј Рё РІС‹РІРѕРґРѕРј РѕР±С‰РµР№ РїРµСЂРµРјРµРЅРЅРѕР№
        int consol_x{ 0 };
        
        //std::thread::id thisThreadId = std::this_thread::get_id();
        mt.lock();
        SetCursor(0, number_th);
        SetColor(1, 0);
        std::cout << "Id: " << std::this_thread::get_id() << " РџРѕС‚РѕРє: " << number_th << " ";


        auto start = std::chrono::steady_clock::now();

        mt.unlock();
        for (int i = 0; i < _long_math; ++i) {
            mt.lock();
            std::this_thread::sleep_for(std::chrono::milliseconds((_rnd()%10)*10));
            _count.store(i); 
            consol_x = 20 + _count.load();
            SetCursor(consol_x, number_th);
            SetColor(5, 5);
            std::cout << " ";
            mt.unlock();
        } 

        auto end = std::chrono::steady_clock::now();
        std::chrono::duration<double> elapsed_seconds = end - start;

        mt.lock();
          SetCursor(consol_x , number_th);  
          SetColor(1, 0);
          std::cout << " Р’СЂРµРјСЏ, s - " << elapsed_seconds.count() ;
        mt.unlock();

    }

    int _thr_blocks{ 0 };    
    int _long_math{ 0 };
    std::atomic<int> _count;//РѕР±С‰Р°СЏ Р°С‚РѕРјР°СЂРЅР°СЏ РїРµСЂРµРјРµРЅРЅР°СЏ
    std::random_device _rnd;

    std::vector<std::function<void(void)>> _vec_lambda; //РІРµРєС‚РѕСЂ РґР»СЏ Р»СЏРјР±Рґ 
    std::vector<std::thread> _threads;//РІРµРєС‚РѕСЂ РґР»СЏ РїРѕС‚РѕРєРѕРІ
};


int main()
{
    SetConsoleCP(1251);
    SetConsoleOutputCP(1251);
    std::string text{ "y" };
    bool go_x{ false };
    int block{ 5 };

    do {

        try {
            std::cout << "\033[2J";

            AAA a1(40, block);
            a1.~AAA();

            SetColor(6, 0);
            SetCursor(0, block+2);

            std::cout << std::endl;
            for (int i = 0; i < 50; ++i) {
                std::cout << "--";
            }
            std::cout << std::endl;
        }
        catch (std::exception& e)
        {
            std::cerr << e.what() << std::endl;
        }
        catch (...)
        {
            std::cerr << "РќРµ РёР·РІРµСЃС‚РЅРѕРµ РёСЃРєР»СЋС‡РµРЅРёРµ!" << std::endl;
        }

        std::cout << "РџСЂРѕРґРѕР»Р¶РёС‚СЊ? Р’РµРµРґРёС‚Рµ y/n: ";
        std::cin >> text;

        if (text == "y") {
            go_x = true;
        }
        else {
            go_x = false;
           
        }

    } while (go_x);
}
